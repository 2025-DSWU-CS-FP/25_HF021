import{G as K,r as n,j as e,R as O,n as ae,t as oe,c as ie,q as le,u as ce,b as ue,l as de,H as me}from"./index-D9A7aE9K.js";import{S as P}from"./image1-BQ0V6IW6.js";import{L as fe,t as he,a as xe}from"./logo-3n7myPKj.js";import{B as ge}from"./BackButton-BKRf_v3q.js";import{D as pe}from"./Divider-FHerT6QG.js";import{g as we,u as ye}from"./getToken-iY5kRPZn.js";import{u as ve,m as be}from"./mutationFactory-BVCIUn7Z.js";const je="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let A=(s=21)=>{let r="",t=crypto.getRandomValues(new Uint8Array(s|=0));for(;s--;)r+=je[t[s]&63];return r};function z(s){return K({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"},child:[]}]})(s)}function q(s){return K({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"},child:[]},{tag:"polyline",attr:{points:"16 6 12 2 8 6"},child:[]},{tag:"line",attr:{x1:"12",y1:"2",x2:"12",y2:"15"},child:[]}]})(s)}const ke="data:image/svg+xml,%3csvg%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cmask%20id='mask0_584_1227'%20style='mask-type:alpha'%20maskUnits='userSpaceOnUse'%20x='0'%20y='0'%20width='24'%20height='24'%3e%3crect%20width='24'%20height='24'%20fill='currentColor'/%3e%3c/mask%3e%3cg%20mask='url(%23mask0_584_1227)'%3e%3cpath%20d='M1.99951%2018.9998V4.99976H21.9995V18.9998H1.99951ZM2.99951%2017.9998H20.9995V5.99976H2.99951V17.9998ZM8.65326%2016.4805H15.3458V14.942H8.65326V16.4805ZM5.53801%2013.2305H7.07651V11.692H5.53801V13.2305ZM9.32651%2013.2305H10.865V11.692H9.32651V13.2305ZM13.134%2013.2305H14.6725V11.692H13.134V13.2305ZM16.9225%2013.2305H18.461V11.692H16.9225V13.2305ZM5.53801%209.98051H7.07651V8.44201H5.53801V9.98051ZM9.32651%209.98051H10.865V8.44201H9.32651V9.98051ZM13.134%209.98051H14.6725V8.44201H13.134V9.98051ZM16.8265%2010.0768H18.365V8.53826H16.8265V10.0768Z'%20fill='currentColor'/%3e%3c/g%3e%3c/svg%3e",Ne="/assets/image2-BbgEYZhO.png";function Ce({children:s,isVisible:r,onExpandChange:t}){const h=n.useRef(null),[m,v]=n.useState(null),[x,w]=n.useState(!1),[u,a]=n.useState(0),b=n.useRef(0),k=70,o=window.innerHeight*(1-100/100),d=window.innerHeight*(1-k/100),g=u===o;n.useEffect(()=>{r&&(a(d),b.current=d)},[r,d]),n.useEffect(()=>{b.current=u},[u]),n.useEffect(()=>{if(!t)return;const f=(d+o)/2;t(u<f)},[u,o,d,t]);const l=f=>{g||(v(f.clientY),w(!0))},c=n.useCallback(f=>{if(!x||m===null)return;const p=f.clientY-m,E=Math.min(Math.max(b.current+p,o),d);a(E)},[x,m,o,d]),i=n.useCallback(()=>{w(!1);const f=(d+o)/2;a(p=>p<f?o:d)},[o,d]);return n.useEffect(()=>(x?(window.addEventListener("pointermove",c),window.addEventListener("pointerup",i)):(window.removeEventListener("pointermove",c),window.removeEventListener("pointerup",i)),()=>{window.removeEventListener("pointermove",c),window.removeEventListener("pointerup",i)}),[x,c,i]),r?e.jsx("div",{className:"fixed flex w-full max-w-[43rem] items-end justify-center transition-all duration-500 ease-in-out",children:e.jsxs("div",{ref:h,onPointerDown:l,className:`w-full max-w-[43rem] touch-none bg-gray-5 transition-transform duration-300 ${g?"":"rounded-t-[2.4rem]"} `,style:{transform:`translateY(${u}px)`,height:`calc(100vh - ${u}px)`,touchAction:"none"},children:[!g&&e.jsx("div",{className:"mx-auto my-[1.9rem] h-[0.35rem] w-[5rem] cursor-pointer rounded-full bg-gray-30"}),e.jsx("div",{className:"max-h-[calc(100%-6.4rem)] overflow-y-auto pb-[20rem]",children:s})]})}):null}const Se="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cmask%20id='mask0_566_1347'%20style='mask-type:alpha'%20maskUnits='userSpaceOnUse'%20x='0'%20y='0'%20width='24'%20height='24'%3e%3crect%20width='24'%20height='24'%20fill='%23D9D9D9'/%3e%3c/mask%3e%3cg%20mask='url(%23mask0_566_1347)'%3e%3cpath%20d='M7.37549%2017.557V6.44152H8.87549V17.557H7.37549ZM11.2505%2021.4993V2.49927H12.7505V21.4993H11.2505ZM3.50049%2013.653V10.3455H5.00049V13.653H3.50049ZM15.1255%2017.557V6.44152H16.6255V17.557H15.1255ZM19.0005%2013.653V10.3455H20.5005V13.653H19.0005Z'%20fill='white'/%3e%3c/g%3e%3c/svg%3e";function Ee({fill:s="#696969",size:r=24}){return e.jsxs("svg",{width:r,height:r,viewBox:"0 0 30 30",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("mask",{id:"mask0",style:{maskType:"alpha"},maskUnits:"userSpaceOnUse",x:"0",y:"0",width:"24",height:"24",children:e.jsx("rect",{width:"24",height:"24",fill:s})}),e.jsx("g",{mask:"url(#mask0)",children:e.jsx("path",{d:"M14.0599 22.0672V10.1347L9.24736 14.9472L7.93018 13.6297L14.9974 6.5625L22.0646 13.6297L20.7474 14.9472L15.9349 10.1347V22.0672H14.0599Z",fill:s})})]})}function He({onSend:s}){const[r,t]=n.useState(""),[h,m]=n.useState(!1),v=n.useRef(null),x=222,w=r.trim().length>0,u=()=>{const a=r.trim();a&&(s==null||s(a),t(""))};return n.useEffect(()=>{const a=v.current;a&&(a.style.height="auto",a.style.height=`${Math.min(a.scrollHeight,x)}px`)},[r]),e.jsxs("div",{className:"flex w-screen max-w-[430px] flex-col gap-2 rounded-t-[2.4rem] bg-gray-10 px-[2.4rem] py-[1.8rem]",children:[e.jsx("textarea",{ref:v,value:r,onChange:a=>t(a.target.value),onCompositionStart:()=>m(!0),onCompositionEnd:()=>m(!1),onKeyDown:a=>{const k=a.key==="Enter"&&!a.shiftKey&&!a.ctrlKey&&!a.metaKey&&!a.altKey,j=a.nativeEvent;k&&!h&&!j.isComposing&&(a.preventDefault(),a.stopPropagation(),u())},placeholder:"작품에 대해 질문해보세요",rows:1,enterKeyHint:"send",className:"caret-cherry max-h-[22.2rem] w-full resize-none overflow-y-auto bg-transparent text-gray-90 outline-none bd2 placeholder:text-gray-50"}),e.jsxs("div",{className:"flex w-full justify-end gap-2",children:[e.jsx("button",{type:"button","aria-label":"음성 인식",className:"flex items-center justify-center rounded-full bg-gray-20 px-[1.3rem] py-[0.6rem] hover:bg-gray-30/90 active:bg-gray-30",children:e.jsx("img",{src:Se,alt:"마이크"})}),e.jsx("button",{type:"button","aria-label":"보내기",onClick:u,disabled:!w,className:`flex items-center justify-center rounded-full px-[1.3rem] py-[0.6rem] transition-colors ${w?"bg-brand-blue hover:bg-brand-blue-light":"cursor-default bg-gray-20"}`,children:e.jsx(Ee,{fill:w?"#ffffff":"#C4C8CD"})})]})]})}function Re({top:s,left:r,menuRef:t,onExtract:h,onCancel:m}){return e.jsx("div",{ref:t,className:"absolute z-50",style:{top:s,left:r},children:e.jsxs("div",{className:"relative inline-flex flex-col items-center",children:[e.jsx("div",{className:"h-0 w-0 border-x-[6px] border-b-[6px] border-x-transparent border-b-gray-80"}),e.jsxs("div",{className:"flex items-center gap-[1.2rem] rounded-[4px] bg-gray-80 px-[1.2rem] py-[0.6rem]",children:[e.jsx("button",{type:"button","aria-label":"취소",className:"text-gray-0 bt3",onClick:m,children:"취소"}),e.jsx("div",{className:"h-[1.2rem] w-px bg-gray-5"}),e.jsx("button",{type:"button","aria-label":"발췌",className:"text-gray-0 bt3",onClick:h,children:"발췌"})]})]})})}function $({text:s,isFromUser:r=!1,onExtract:t}){const h=n.useRef(null),m=n.useRef(null),[v,x]=n.useState(null),w=n.useRef(!1),u=n.useRef(null),a=n.useRef(null),b=n.useCallback(o=>{if(!o||o.isCollapsed)return!1;const d=h.current;if(!d)return!1;const g=o.anchorNode,l=o.focusNode;return!!(g&&l&&d.contains(g)&&d.contains(l))},[]),k=n.useCallback(()=>{const o=window.getSelection();if(!b(o)){x(null);return}const g=o.getRangeAt(0).getClientRects(),l=h.current;if(!g.length||!l)return;const c=g[g.length-1],i=l.getBoundingClientRect(),f=o.toString().trim();if(!f){x(null);return}const p=c.bottom-i.top+6,E=c.left-i.left,C=Math.max(8,Math.min(E,i.width-120));x({top:p,left:C,quote:f})},[b]),j=n.useCallback((o=60)=>{u.current&&cancelAnimationFrame(u.current),a.current!==null&&(clearTimeout(a.current),a.current=null),a.current=window.setTimeout(()=>{u.current=requestAnimationFrame(k)},o)},[k]);return n.useEffect(()=>{const o=()=>{w.current&&j(0)},d=c=>{var E,C;const i=c.target,f=!!(i&&((E=h.current)!=null&&E.contains(i)));if(!(i&&((C=m.current)!=null&&C.contains(i))))if(f)w.current=!0;else{w.current=!1,x(null);const N=window.getSelection();N&&!N.isCollapsed&&N.removeAllRanges()}},g=()=>{w.current=!1,j(80)},l=c=>{(c.key==="Shift"||c.key.startsWith("Arrow"))&&j(0)};return document.addEventListener("selectionchange",o),document.addEventListener("pointerdown",d,{passive:!0}),document.addEventListener("pointerup",g),document.addEventListener("mouseup",g),document.addEventListener("keyup",l),()=>{u.current&&cancelAnimationFrame(u.current),a.current!==null&&clearTimeout(a.current),document.removeEventListener("selectionchange",o),document.removeEventListener("pointerdown",d),document.removeEventListener("pointerup",g),document.removeEventListener("mouseup",g),document.removeEventListener("keyup",l)}},[j]),e.jsxs("div",{ref:h,className:`relative max-w-[80%] select-text whitespace-pre-wrap break-words rounded-[8px] px-[1.4rem] py-[1rem] bd3 ${r?"self-end bg-brand-blue text-gray-0":"bg-gray-0 text-gray-90"}`,style:{overflow:"visible"},children:[v&&e.jsx(Re,{top:v.top,left:v.left,menuRef:m,onExtract:()=>{var o;t==null||t(v.quote),x(null),(o=window.getSelection())==null||o.removeAllRanges()},onCancel:()=>{var o;x(null),(o=window.getSelection())==null||o.removeAllRanges()}}),s]})}const Me="data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cmask%20id='mask0_566_1887'%20style='mask-type:alpha'%20maskUnits='userSpaceOnUse'%20x='0'%20y='0'%20width='24'%20height='24'%3e%3crect%20width='24'%20height='24'%20fill='%23D9D9D9'/%3e%3c/mask%3e%3cg%20mask='url(%23mask0_566_1887)'%3e%3cpath%20d='M5.6155%2020C5.15517%2020%204.77083%2019.8458%204.4625%2019.5375C4.15417%2019.2292%204%2018.8448%204%2018.3845V5.6155C4%205.15517%204.15417%204.77083%204.4625%204.4625C4.77083%204.15417%205.15517%204%205.6155%204H12.6155V5H5.6155C5.436%205%205.2885%205.05767%205.173%205.173C5.05767%205.2885%205%205.436%205%205.6155V18.3845C5%2018.564%205.05767%2018.7115%205.173%2018.827C5.2885%2018.9423%205.436%2019%205.6155%2019H18.3845C18.564%2019%2018.7115%2018.9423%2018.827%2018.827C18.9423%2018.7115%2019%2018.564%2019%2018.3845V11.3845H20V18.3845C20%2018.8448%2019.8458%2019.2292%2019.5375%2019.5375C19.2292%2019.8458%2018.8448%2020%2018.3845%2020H5.6155ZM6.76925%2016.3845H17.2308L14%2012.077L11%2015.8655L9%2013.4615L6.76925%2016.3845ZM17%209V7H15V6H17V4H18V6H20V7H18V9H17Z'%20fill='white'/%3e%3c/g%3e%3c/svg%3e",Ve="data:image/svg+xml,%3csvg%20width='25'%20height='24'%20viewBox='0%200%2025%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cmask%20id='mask0_566_1892'%20style='mask-type:alpha'%20maskUnits='userSpaceOnUse'%20x='0'%20y='0'%20width='25'%20height='24'%3e%3crect%20x='0.5'%20width='24'%20height='24'%20fill='%23D9D9D9'/%3e%3c/mask%3e%3cg%20mask='url(%23mask0_566_1892)'%3e%3cpath%20d='M12%2015.577V6.927L9.66925%209.25775L8.9615%208.5385L12.5%205L16.0385%208.5385L15.3307%209.25775L13%206.927V15.577H12ZM7.1155%2019C6.65517%2019%206.27083%2018.8458%205.9625%2018.5375C5.65417%2018.2292%205.5%2017.8448%205.5%2017.3845V14.9615H6.5V17.3845C6.5%2017.5385%206.56408%2017.6796%206.69225%2017.8077C6.82042%2017.9359%206.9615%2018%207.1155%2018H17.8845C18.0385%2018%2018.1796%2017.9359%2018.3077%2017.8077C18.4359%2017.6796%2018.5%2017.5385%2018.5%2017.3845V14.9615H19.5V17.3845C19.5%2017.8448%2019.3458%2018.2292%2019.0375%2018.5375C18.7292%2018.8458%2018.3448%2019%2017.8845%2019H7.1155Z'%20fill='white'/%3e%3c/g%3e%3c/svg%3e";function Le({imageUrl:s,quote:r,title:t,artist:h,onSave:m,onShare:v}){const x=O.useRef(null),[w,u]=O.useState(!1),a=async()=>{var c;const l=document;try{await((c=l.fonts)==null?void 0:c.ready)}catch{}},b=async l=>{const c=Array.from(l.querySelectorAll("img"));c.length!==0&&await Promise.all(c.map(i=>{if(i.complete&&i.naturalWidth>0)return Promise.resolve();const f=i.decode;return typeof f=="function"?f.call(i).catch(()=>{}):new Promise(p=>{i.addEventListener("load",()=>p(),{once:!0}),i.addEventListener("error",()=>p(),{once:!0})})}))},k=()=>new Promise(l=>{requestAnimationFrame(()=>{l()})}),j=async()=>{await k(),await k()},o=async()=>{const l=x.current;if(!l)throw new Error("no target");ae.flushSync(()=>u(!0)),await a(),await b(l),await j();const c=l.getBoundingClientRect(),i=Math.round(c.width),f=Math.round(c.height),p=Math.min(2,window.devicePixelRatio||1),E={transform:"none",transformOrigin:"top left",margin:"0",padding:"0",borderRadius:getComputedStyle(l).borderRadius,overflow:"hidden",webkitTextSizeAdjust:"100%"},C={backgroundColor:void 0,width:i,height:f,pixelRatio:1,style:E,cacheBust:!0,preferCanvas:!0,filter:S=>!(S instanceof Element&&S.classList.contains("capture-ignore")),onClone:(S,V)=>{V.querySelectorAll("img").forEach(D=>{const L=D;L.crossOrigin="anonymous",L.loading="eager",Object.assign(L.style,{position:"absolute",inset:"0",width:"100%",height:"100%",objectFit:"cover",transform:"translateZ(0)"})})}};let N=null;try{N=await he(l,{...C,pixelRatio:p})}catch{}if(!N){const S=await xe(l,{...C,pixelRatio:p});N=await(await fetch(S)).blob()}return N},d=async()=>{if(!w)try{const l=await o(),c=URL.createObjectURL(l),i=document.createElement("a");i.href=c,i.download=`${t||"eyedia"}-extract.png`,document.body.appendChild(i),i.click(),i.remove(),URL.revokeObjectURL(c),m()}finally{u(!1)}},g=async()=>{var l;if(!w)try{const c=await o(),i=new File([c],`${t||"eyedia"}-extract.png`,{type:"image/png"}),f=navigator;if(typeof f.share=="function"&&((l=f.canShare)!=null&&l.call(f,{files:[i]})))await f.share({files:[i],title:t||"Eyedia"});else{const p=URL.createObjectURL(c);window.open(p,"_blank"),setTimeout(()=>URL.revokeObjectURL(p),1e4)}v()}finally{u(!1)}};return e.jsx("div",{className:"fixed inset-0 z-10 flex items-center justify-center",children:e.jsxs("div",{className:`mx-auto flex h-[100dvh] w-full max-w-[43rem] flex-col bg-gray-0 ${w?"capture-still":""}`,children:[e.jsx("div",{className:"pt-[max(1rem,env(safe-area-inset-top))]",children:e.jsx(ge,{className:"capture-ignore text-gray-100"})}),e.jsxs("div",{ref:x,className:"relative mx-auto my-auto h-[50rem] w-[90%] overflow-hidden rounded-[16px]",style:{isolation:"isolate"},children:[e.jsx("img",{src:s,alt:"artwork",crossOrigin:"anonymous",className:"h-full w-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/45"}),e.jsxs("div",{className:"absolute left-[1.5rem] top-[1.5rem] flex items-center gap-[0.5rem]",children:[e.jsx("img",{src:fe,alt:"로고",crossOrigin:"anonymous",className:"h-[3rem] w-[3rem]"}),e.jsx("span",{className:"font-bold text-gray-0 t4",children:"EYEDIA"})]}),e.jsx("div",{className:"absolute bottom-28 left-6 right-6 top-0 flex items-center",children:e.jsx("p",{className:"leading-relaxed text-white bd1",children:r})}),e.jsxs("div",{className:"absolute bottom-[2.6rem] left-6 right-6 flex flex-col gap-[1.6rem] text-white/90",children:[e.jsx("div",{className:"h-px bg-white/30"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-white t4",children:t}),e.jsx("div",{className:"mt-1 ct4",children:h})]})]})]}),e.jsx("div",{className:"mt-auto flex w-full justify-center pb-[max(2rem,env(safe-area-inset-bottom))]",children:e.jsxs("div",{className:"capture-ignore flex items-center gap-[2.7rem] rounded-full bg-brand-blue px-10 py-4 shadow-lg",children:[e.jsxs("button",{type:"button",onClick:d,className:"flex flex-col items-center text-white","aria-label":"이미지 저장",children:[e.jsx("img",{src:Me,alt:"저장",className:"h-[2.4rem] w-[2.4rem]"}),e.jsx("span",{className:"mt-1 ct4",children:"이미지 저장"})]}),e.jsxs("button",{type:"button",onClick:g,className:"flex flex-col items-center text-white","aria-label":"SNS 공유",children:[e.jsx("img",{src:Ve,alt:"공유",className:"h-[2.4rem] w-[2.4rem]"}),e.jsx("span",{className:"mt-1 ct4",children:"SNS 공유"})]})]})})]})})}const Ae={sm:"w-8 h-6 text-base",md:"w-11 h-8 text-xl",lg:"w-14 h-10 text-2xl"};function T({icon:s,bgColor:r="bg-gray-10 hover:bg-gray-10/90 active:bg-gray-10/80",iconColor:t="text-brand-blue",size:h="md",className:m=""}){return e.jsx("div",{className:oe(`flex cursor-pointer items-center justify-center rounded-full px-[1.1rem] py-[0.7rem] backdrop-blur-sm ${r} ${t} ${Ae[h]}`,m),children:s})}const I={checkingConnection:"연결을 확인하는 중이에요.",speaking:"말씀하세요 :)",generating:"답변을 생성하는 중이에요…",ask:"버튼을 누르고 작품에 대해 물어보세요."};function Te(){const s=n.useRef(null),r=()=>{var t;return(t=s.current)==null||t.abort("renew"),s.current=new AbortController,s.current};return n.useEffect(()=>()=>{var t;return(t=s.current)==null?void 0:t.abort("unmount")},[]),{ref:s,renew:r,signal:()=>{var t;return(t=s.current)==null?void 0:t.signal}}}function Ie(s,r){n.useEffect(()=>{requestAnimationFrame(()=>{var h;return(h=r.current)==null?void 0:h.scrollIntoView({behavior:"smooth",block:"end",inline:"nearest"})})},s)}function De(){const s=n.useRef([]),r=t=>(s.current.push(t),t);return n.useEffect(()=>()=>{s.current.forEach(t=>{window.clearTimeout(t),window.clearInterval(t)}),s.current=[]},[]),{add:r}}function Ue(s){const r=n.useRef({});return{start:(m,v,x,w=16)=>{r.current[m]=!0;let u=0;const a=()=>{if(!r.current[m]||(u+=1,x(v.slice(0,u)),u>=v.length))return;const b=window.setTimeout(a,w);s(b)};a()},stop:m=>{r.current[m]=!1}}}function _e(){return ve({mutationFn:s=>be.saveScrap(s)})}const Ze=(s,r=!0)=>ie({queryKey:["chatMessages",s],queryFn:le.chatMessages(s),enabled:r,staleTime:0,retry:!1}),Be="https://eyedia.site";async function Fe(s,r){try{const t=await fetch(`${Be}/api/v1/chats/ask`,{method:"POST",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify(s),signal:r,cache:"no-store",keepalive:!0,credentials:"include",mode:"cors"});if(!t.ok){const h=await t.text().catch(()=>"");throw new Error(`ask failed: ${t.status} ${h}`)}return await t.json()}catch(t){throw t instanceof DOMException&&t.name==="AbortError",t}}function Oe(){return new Intl.DateTimeFormat("en-CA",{timeZone:"Asia/Seoul",year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date)}const R={title:"발레 수업",artist:"에드가 드가"},Y="한이음 전시회",Pe=200001;function Qe(){const{state:s}=ce(),r=(s==null?void 0:s.paintingId)??Pe,[t,h]=n.useState(!1),[m,v]=n.useState(!1),[x,w]=n.useState(!1),[u,a]=n.useState(""),[b,k]=n.useState(!1),[j,o]=n.useState([]),[d,g]=n.useState(!1),l=n.useRef(0),c=n.useRef(null),i=n.useRef(null),f=n.useRef(null),{data:p}=Ze(r),E=we(),{connected:C,messages:N}=ye({paintingId:r,token:E}),{showToast:S}=ue(),V=de(),{mutate:D,isPending:L}=_e(),{add:B}=De(),G=Te(),{start:X}=Ue(B);Ie([p,N,j,d],i);const Q=n.useMemo(()=>(p??[]).map(y=>({id:A(),content:y.content,sender:y.sender,type:"TEXT"})),[p]),W=N.map(y=>({id:y.id??A(),sender:y.sender,content:y.content,type:"TEXT"})),J=n.useMemo(()=>C?m?I.speaking:d?I.generating:I.ask:I.checkingConnection,[C,m,d]),F=m||d||!C,ee=()=>{const y=u.trim();if(!y){S("저장할 발췌 문구가 없어요.","error");return}D({paintingId:r,date:Oe(),excerpt:y,location:Y,artist:R.artist},{onSuccess:H=>{S(H.message||"발췌를 저장했어요.","success"),k(!1),V.invalidateQueries({queryKey:["recentViewedArtworks"]}),V.invalidateQueries({queryKey:["scrapsByExhibition"]})},onError:()=>S("저장에 실패했어요. 다시 시도해 주세요.","error")})},te=async y=>{const H=y.trim();if(H){o(M=>[...M,{id:A(),sender:"USER",type:"TEXT",content:H}]),g(!0);try{const{signal:M}=G.renew(),ne=await Fe({artId:r,text:H},M);g(!1);const U=A();o(_=>[..._,{id:U,sender:"BOT",type:"TEXT",content:""}]),X(U,ne.answer,_=>o(re=>re.map(Z=>Z.id===U?{...Z,content:_}:Z)),16)}catch(M){g(!1),M instanceof DOMException&&M.name==="AbortError"||S("질문 전송에 실패했어요. 다시 시도해 주세요.","error")}}},se=()=>{m||d||(v(!0),B(window.setTimeout(()=>{v(!1),l.current===0?(o(y=>[...y,{id:A(),sender:"USER",type:"IMAGE",imageUrl:Ne}]),l.current=1):w(!0)},3e3)))};return e.jsxs("section",{className:"relative h-dvh w-full overflow-hidden bg-gray-5 text-gray-100",children:[e.jsx("div",{className:"pointer-events-none absolute left-0 top-0 h-full w-full",children:e.jsx("img",{src:P,alt:"작품 이미지",className:"pointer-events-none h-full min-h-[35vh] w-full touch-none select-none object-cover",draggable:!1})}),t&&e.jsxs("header",{className:"absolute z-[1] w-full border-b-2 border-gray-10 bg-gray-5 pb-4",children:[e.jsx(me,{showBackButton:!0,backgroundColorClass:"bg-gray-5"}),e.jsxs("div",{className:"flex max-w-[100%] items-end justify-between px-[2.3rem]",children:[e.jsxs("div",{className:"flex flex-col gap-[0.3rem]",children:[e.jsx("h1",{className:"t3",children:R.title}),e.jsx("p",{className:"text-gray-70 ct5",children:R.artist})]}),e.jsxs("div",{className:"flex gap-[0.8rem]",children:[e.jsx(T,{size:"lg",icon:e.jsx(z,{})}),e.jsx(T,{size:"lg",icon:e.jsx(q,{})})]})]})]}),e.jsx(Ce,{isVisible:!0,onExpandChange:h,children:e.jsxs("main",{className:`relative ${t?"pt-[11.2rem]":""}`,children:[!t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"fixed -top-4 right-7 z-20 flex justify-end gap-2",children:[e.jsx(T,{size:"lg",icon:e.jsx(z,{})}),e.jsx(T,{size:"lg",icon:e.jsx(q,{})})]}),e.jsxs("div",{className:"mb-4 flex select-none flex-col gap-[1.8rem]",children:[e.jsxs("div",{className:"px-[2.4rem]",children:[e.jsxs("div",{className:"flex flex-col gap-[0.3rem]",children:[e.jsxs("h1",{className:"font-normal t1",children:[R.title," "]}),e.jsx("p",{className:"text-gray-70 ct4",children:R.artist})]}),e.jsx("p",{className:"text-gray-50 ct4",children:Y})]}),e.jsx(pe,{})]})]}),e.jsxs("div",{ref:c,className:"flex h-full flex-col gap-[1.2rem] overflow-y-auto px-[1.8rem] pt-8",children:[(!p||p.length===0)&&j.length===0&&N.length===0&&e.jsx("div",{className:"pb-[1.2rem] pt-[1.6rem]",children:e.jsx($,{text:"무물이에게 작품에 대해 궁금한 점을 물어보세요(2초 이상 응시한 객체에 대해서 설명해 줍니다)."})}),[...Q,...W,...j].map(y=>y.type==="IMAGE"?e.jsx("figure",{className:"max-w-[75%] self-end overflow-hidden rounded-[20px] bg-gray-10",children:e.jsx("img",{src:y.imageUrl,alt:"선택한 부분 이미지",className:"block h-auto w-full object-cover"})},y.id):e.jsx($,{text:y.content,isFromUser:y.sender==="USER",onExtract:H=>{a(H),k(!0)}},y.id)),d&&e.jsx("div",{className:"flex items-start gap-[1rem]",children:e.jsxs("div",{className:"rounded-[20px] bg-gray-10 px-[1.2rem] py-[0.8rem]",children:[e.jsx("span",{className:"sr-only",children:"상대가 입력 중…"}),e.jsxs("div",{className:"flex items-end gap-[0.4rem]",children:[e.jsx("span",{className:"typing-dot"}),e.jsx("span",{className:"typing-dot delay-1"}),e.jsx("span",{className:"typing-dot delay-2"})]})]})}),e.jsx("div",{ref:i})]})]})}),!x&&e.jsxs("footer",{className:"pointer-events-none fixed bottom-0 left-0 flex w-full flex-col items-center bg-transparent px-6 pb-[1rem]",children:[e.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-b from-transparent to-gray-5"}),e.jsx("div",{className:"pointer-events-auto relative z-10 mt-[1.3rem] flex size-[12.8rem] items-center justify-center",children:m?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"wave"}),e.jsx("span",{className:"wave delay-1"}),e.jsx("span",{className:"wave delay-2"}),e.jsx("div",{className:"glow-core wave-border"})]}):e.jsx("button",{"aria-label":"음성 인식 시작",type:"button",disabled:F,"aria-disabled":F,className:"glow-pulse disabled:cursor-not-allowed disabled:opacity-50",onClick:se})}),e.jsx("p",{className:"relative z-10 mt-6 text-gray-70 bd2",children:J}),e.jsxs("div",{className:"pointer-events-auto relative z-10 mx-auto mt-4 flex w-full max-w-[430px] justify-end",children:[e.jsx("input",{ref:f,type:"text",className:"sr-only"}),e.jsx("button",{type:"button",onClick:()=>w(!0),className:"flex items-center justify-center rounded-[40px] bg-gray-10 px-[1.3rem] py-[0.6rem] hover:bg-gray-20/80 active:bg-gray-20","aria-label":"키보드 입력으로 질문하기",children:e.jsx("img",{src:ke,alt:"키보드",className:"w-[2.4rem] text-gray-80"})})]})]}),x&&e.jsx("div",{className:"fixed bottom-0 left-1/2 z-20 w-full max-w-[430px] -translate-x-1/2",children:e.jsx(He,{onSend:te})}),b&&e.jsx("div",{className:"fixed left-0 top-0 z-50 flex h-full w-full items-center justify-center",children:e.jsx(Le,{imageUrl:P,quote:u,title:R.title,artist:R.artist,onSave:ee,onShare:()=>S("공유 기능은 준비 중이에요.","info"),"aria-busy":L})})]})}export{Qe as default};
